<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Smart Timetable App</title>
<style>
  :root{
    --accent:#0b84ff;
    --muted:#666;
    --card:#fff;
    --bg:#f4f7fb;
    --glass: rgba(255,255,255,0.8);
  }
  *{box-sizing:border-box;font-family:Inter, system-ui, Arial;}
  body{margin:0;background:linear-gradient(180deg,#eef6ff 0%, #f8fbff 100%);color:#111;}
  .container{max-width:980px;margin:28px auto;padding:18px;}
  .card{background:var(--card);border-radius:12px;box-shadow:0 6px 24px rgba(20,30,60,0.08);padding:18px;}
  header{display:flex;align-items:center;justify-content:space-between;gap:12px;margin-bottom:14px;}
  h1{font-size:20px;margin:0;}
  small{color:var(--muted)}
  .row{display:flex;gap:12px;flex-wrap:wrap;}
  .col{flex:1;min-width:220px;}
  label{display:block;font-size:13px;margin-bottom:6px;color:var(--muted);}
  input,select,button,textarea{width:100%;padding:10px;border-radius:8px;border:1px solid #e3e8ef;background:transparent;}
  button{cursor:pointer;background:var(--accent);color:#fff;border:none;padding:10px 12px;font-weight:600;}
  .secondary{background:#fff;border:1px solid #e3e8ef;color:#111;}
  .timetable-wrap{display:flex;gap:12px;flex-wrap:wrap;margin-top:12px;}
  .left{flex:1;min-width:300px;}
  .right{flex:1;min-width:300px;}
  .img-wrap{border-radius:8px;overflow:hidden;border:1px solid #e8eef8;height:100%}
  .img-wrap img{width:100%;height:100%;object-fit:contain;display:block;}
  table{width:100%;border-collapse:collapse;margin-top:8px;}
  th,td{border:1px solid #e8eef8;padding:8px;text-align:center;font-size:13px;}
  th{background:linear-gradient(90deg,#f6fbff,#ffffff);font-weight:700;}
  .header-bar{display:flex;gap:12px;align-items:center;justify-content:space-between;padding:12px;border-radius:8px;background:linear-gradient(90deg,#0b84ff22,#fff);margin-bottom:12px;}
  .current{font-weight:700;font-size:16px;}
  .countdown{font-size:16px;color:var(--muted);}
  .controls{display:flex;gap:8px;align-items:center;}
  .edit-row{display:flex;gap:8px;margin-top:8px;}
  .day-select{display:flex;gap:6px;flex-wrap:wrap;margin-top:6px;}
  .chip{padding:8px 10px;border-radius:999px;border:1px solid #e3e8ef;background:#fff;cursor:pointer;}
  .chip.active{background:var(--accent);color:#fff;border:none;}
  .editable td{background:#fbfdff}
  .note{font-size:13px;color:var(--muted);margin-top:8px}
  @media(max-width:880px){
    header{flex-direction:column;align-items:flex-start;gap:10px;}
    .timetable-wrap{flex-direction:column;}
  }
</style>
</head>
<body>
  <div class="container">
    <div id="app" class="card">
      <!-- LOGIN / DETAILS -->
      <div id="detailsView">
        <header>
          <div>
            <h1>Smart Timetable App</h1>
            <small>Enter your details once — we'll remember them.</small>
          </div>
          <div>
            <small id="greetNow"></small>
          </div>
        </header>

        <div class="row">
          <div class="col">
            <label for="stuName">Name</label>
            <input id="stuName" placeholder="Your name (e.g. Rahul)" />
          </div>
          <div class="col">
            <label for="stuRoll">Roll No.</label>
            <input id="stuRoll" placeholder="Roll number" />
          </div>
          <div class="col">
            <label for="stuDiv">Division</label>
            <select id="stuDiv">
              <option value="A">Division A</option>
              <option value="B">Division B</option>
              <option value="C">Division C</option>
              <option value="D">Division D</option>
              <option value="E">Division E</option>
            </select>
          </div>
        </div>

        <div style="display:flex;gap:10px;margin-top:12px;">
          <button id="startBtn">Start App</button>
          <button id="clearBtn" class="secondary">Clear Saved Details</button>
        </div>

        <p class="note">Tip: App saves details locally on your browser. To change division later, use the "Change Details" button inside app.</p>
      </div>

      <!-- TIMETABLE VIEW -->
      <div id="timetableView" style="display:none;">
        <header>
          <div>
            <h1 id="appTitle">Your Timetable</h1>
            <small id="studentInfo"></small>
          </div>
          <div class="controls">
            <button id="editDetails" class="secondary">Change Details</button>
            <button id="toggleEdit" class="secondary">Edit Timetable</button>
            <button id="resetTimetable" class="secondary">Reset Timetable</button>
          </div>
        </header>

        <div class="header-bar">
          <div>
            <div class="current" id="currentClassText">—</div>
            <div class="countdown" id="countdownText">—</div>
          </div>
          <div style="text-align:right">
            <div><small id="todayLabel"></small></div>
            <div style="margin-top:6px">
              <select id="divisionSelect" style="padding:8px;border-radius:8px;border:1px solid #e8eef8;">
                <option value="A">Division A</option>
                <option value="B">Division B</option>
                <option value="C">Division C</option>
                <option value="D">Division D</option>
                <option value="E">Division E</option>
              </select>
            </div>
          </div>
        </div>

        <div class="day-select" id="dayChips"></div>

        <div class="timetable-wrap">
          <div class="left card">
            <div style="font-weight:700;margin-bottom:8px">Timetable (structured)</div>
            <div id="tableContainer"></div>

            <div style="margin-top:10px;display:flex;gap:8px;">
              <button id="saveTable">Save Timetable</button>
              <button id="loadImageBtn" class="secondary">Show Timetable Photo</button>
            </div>

            <p class="note">You can edit any cell then click Save Timetable. Times must be in HH:MM (24-hour) format.</p>
          </div>

          <div class="right card">
            <div style="font-weight:700;margin-bottom:8px">Timetable Photo</div>
            <div class="img-wrap" id="photoWrap">
              <img id="divImage" src="" alt="Division timetable photo" />
            </div>
            <p class="note" style="margin-top:10px">Photo shown is the scanned timetable you provided.</p>
          </div>
        </div>

      </div>

    </div>
  </div>

<script>
/* --------------------------
  Smart Timetable App (JS)
   - localStorage keys:
     student => {name,roll,div}
     timetable_data => object for all divisions
----------------------------*/

// Default structured timetable data (best-effort prefill).
// NOTE: You should verify these subjects/times and edit in the app if needed.
// Format: timetable[division][weekday] = array of {subject, start, end}
// weekday: 0=Sunday,1=Monday,...6=Saturday
const defaultTimetable = {
  A: {
    // Monday
    1: [
      {subject:"DM(A-101)", start:"08:15", end:"09:15"},
      {subject:"SP(A-101)", start:"09:15", end:"10:15"},
      {subject:"Short Break", start:"10:15", end:"10:30"},
      {subject:"C1-DM-TUT(A-004)", start:"10:30", end:"11:30"},
      {subject:"---", start:"11:30", end:"12:30"},
      {subject:"Lunch/Break", start:"12:30", end:"13:15"},
      {subject:"CF(A-016)", start:"13:15", end:"15:15"}
    ],
    // Tues
    2: [
      {subject:"CP-LAB(B100D)", start:"08:15", end:"09:15"},
      {subject:"---", start:"09:15", end:"10:15"},
      {subject:"Short Break", start:"10:15", end:"10:30"},
      {subject:"EMV(A-012)", start:"10:30", end:"11:30"},
      {subject:"ES(A-012)", start:"11:30", end:"12:30"},
      {subject:"Lunch/Break", start:"12:30", end:"13:15"},
      {subject:"---", start:"13:15", end:"15:15"}
    ],
    // Wed
    3: [
      {subject:"CP(A-201)", start:"08:15", end:"09:15"},
      {subject:"SP(A-201)", start:"09:15", end:"10:15"},
      {subject:"Short Break", start:"10:15", end:"10:30"},
      {subject:"ECS", start:"10:30", end:"11:30"},
      {subject:"---", start:"11:30", end:"12:30"},
      {subject:"Lunch/Break", start:"12:30", end:"13:15"},
      {subject:"CF(A-016)", start:"13:15", end:"15:15"}
    ],
    // Thu
    4: [
      {subject:"CF-LAB-B110B", start:"08:15", end:"09:15"},
      {subject:"---", start:"09:15", end:"10:15"},
      {subject:"Short Break", start:"10:15", end:"10:30"},
      {subject:"DTC(A-012)", start:"10:30", end:"11:30"},
      {subject:"ES(A-012)", start:"11:30", end:"12:30"},
      {subject:"Lunch/Break", start:"12:30", end:"13:15"},
      {subject:"EMV(A-104)", start:"13:15", end:"15:15"}
    ],
    // Fri
    5: [
      {subject:"CP(A-016)", start:"08:15", end:"09:15"},
      {subject:"CF(A-016)", start:"09:15", end:"10:15"},
      {subject:"Short Break", start:"10:15", end:"10:30"},
      {subject:"ECS(B-413)", start:"10:30", end:"11:30"},
      {subject:"DM(B-413)", start:"11:30", end:"12:30"},
      {subject:"Lunch/Break", start:"12:30", end:"13:15"},
      {subject:"YF(A-104)", start:"13:15", end:"15:15"}
    ],
    // Sat (if any)
    6: []
  },
  B: JSON.parse(JSON.stringify({})),
  C: JSON.parse(JSON.stringify({})),
  D: JSON.parse(JSON.stringify({})),
  E: JSON.parse(JSON.stringify({}))
};

// For divisions B..E copy A's template (user can edit)
["B","C","D","E"].forEach(d=>{
  // shallow copy Monday..Friday from A to other divisions as template
  defaultTimetable[d] = JSON.parse(JSON.stringify(defaultTimetable.A));
});

// Image mapping (place your images in images/ folder)
const divisionImages = {
  A: "divA.jpg",
  B: "divB.jpg",
  C: "divC.jpg",
  D: "divD.jpg",
  E: "divE.jpg"
};

// util: parse HH:MM into Date object for today
function timeToTodayDate(hhmm){
  const [h,m] = hhmm.split(":").map(Number);
  const d = new Date();
  d.setHours(h, m, 0, 0);
  return d;
}

// load/save functions
function getStudent(){ return JSON.parse(localStorage.getItem("student") || "null"); }
function saveStudent(obj){ localStorage.setItem("student", JSON.stringify(obj)); }
function clearStudent(){ localStorage.removeItem("student"); }

function getTimetable(){
  const raw = localStorage.getItem("timetable_data");
  if(raw) return JSON.parse(raw);
  // else save default copy and return
  localStorage.setItem("timetable_data", JSON.stringify(defaultTimetable));
  return JSON.parse(JSON.stringify(defaultTimetable));
}
function saveTimetable(data){ localStorage.setItem("timetable_data", JSON.stringify(data)); }

// UI elements
const detailsView = document.getElementById("detailsView");
const timetableView = document.getElementById("timetableView");
const stuName = document.getElementById("stuName");
const stuRoll = document.getElementById("stuRoll");
const stuDiv = document.getElementById("stuDiv");
const startBtn = document.getElementById("startBtn");
const clearBtn = document.getElementById("clearBtn");
const greetNow = document.getElementById("greetNow");

const studentInfo = document.getElementById("studentInfo");
const appTitle = document.getElementById("appTitle");
const editDetails = document.getElementById("editDetails");
const divisionSelect = document.getElementById("divisionSelect");
const todayLabel = document.getElementById("todayLabel");
const currentClassText = document.getElementById("currentClassText");
const countdownText = document.getElementById("countdownText");
const tableContainer = document.getElementById("tableContainer");
const divImage = document.getElementById("divImage");
const dayChips = document.getElementById("dayChips");
const toggleEdit = document.getElementById("toggleEdit");
const saveTableBtn = document.getElementById("saveTable");
const loadImageBtn = document.getElementById("loadImageBtn");
const resetTimetableBtn = document.getElementById("resetTimetable");

let timetable = getTimetable();
let countdownInterval = null;
let editingMode = false;
let currentDivision = "A";
let currentDay = (new Date()).getDay(); // 0..6
if(currentDay === 0) currentDay = 1; // prefer Monday as default if Sunday

// init greetings
greetNow.innerText = new Date().toLocaleString();

// prefill details if exist
const s = getStudent();
if(s){
  stuName.value = s.name || "";
  stuRoll.value = s.roll || "";
  stuDiv.value = s.div || "A";
  greetNow.innerText = `Saved: ${s.name} • ${s.div}`;
}

// event handlers
startBtn.addEventListener("click", ()=>{
  const name = stuName.value.trim();
  const roll = stuRoll.value.trim();
  const div = stuDiv.value;
  if(!name || !roll){ alert("Please enter name and roll number."); return; }
  saveStudent({name, roll, div});
  openTimetable();
});

clearBtn.addEventListener("click", ()=>{
  if(confirm("Remove saved details and reset app?")){
    clearStudent();
    localStorage.removeItem("timetable_data");
    location.reload();
  }
});

function openTimetable(){
  const student = getStudent();
  if(!student){ alert("No student saved."); return; }
  detailsView.style.display = "none";
  timetableView.style.display = "block";
  currentDivision = student.div || "A";
  divisionSelect.value = currentDivision;
  displayStudentInfo();
  renderDayChips();
  renderTimetable();
  loadImageForDivision(currentDivision);
  startCountdownLoop();
}

function displayStudentInfo(){
  const stu = getStudent();
  studentInfo.innerText = `${stu.name} • Roll: ${stu.roll} • Division: ${stu.div}`;
  appTitle.innerText = `Timetable — Division ${stu.div}`;
}

editDetails.addEventListener("click", ()=>{
  // show details view and allow change
  const stu = getStudent();
  if(!stu) return;
  detailsView.style.display = "block";
  timetableView.style.display = "none";
  stuName.value = stu.name;
  stuRoll.value = stu.roll;
  stuDiv.value = stu.div;
});

divisionSelect.addEventListener("change", (e)=>{
  currentDivision = e.target.value;
  loadImageForDivision(currentDivision);
  renderTimetable();
});

loadImageBtn.addEventListener("click", ()=>{
  // toggle show/hide image
  const imgWrap = document.getElementById("photoWrap");
  if(imgWrap.style.display === "none") imgWrap.style.display = "block";
  else imgWrap.style.display = "block";
});

toggleEdit.addEventListener("click", ()=>{
  editingMode = !editingMode;
  toggleEdit.innerText = editingMode? "Stop Editing" : "Edit Timetable";
  renderTimetable();
});

saveTableBtn.addEventListener("click", ()=>{
  // read edited table and save into timetable var
  const inputs = document.querySelectorAll(".tt-input");
  const newData = JSON.parse(JSON.stringify(timetable)); // clone
  inputs.forEach(inp=>{
    const d = inp.dataset;
    const div = d.div;
    const day = d.day;
    const idx = Number(d.idx);
    const col = d.col; // subject|start|end
    const val = inp.value.trim();
    if(!newData[div]) newData[div] = {};
    if(!newData[div][day]) newData[div][day] = [];
    // ensure array exists up to idx
    while(newData[div][day].length <= idx){
      newData[div][day].push({subject:"",start:"00:00",end:"00:00"});
    }
    newData[div][day][idx][col] = val;
  });
  timetable = newData;
  saveTimetable(timetable);
  alert("Timetable saved!");
  editingMode = false;
  toggleEdit.innerText = "Edit Timetable";
  renderTimetable();
  startCountdownLoop(); // restart countdown logic in case times changed
});

resetTimetableBtn.addEventListener("click", ()=>{
  if(confirm("Reset timetable to default template?")){
    localStorage.removeItem("timetable_data");
    timetable = getTimetable();
    renderTimetable();
    alert("Reset done.");
  }
});

// day chips
function renderDayChips(){
  // we'll show Monday..Saturday chips (1..6)
  const days = ["Mon","Tue","Wed","Thu","Fri","Sat"];
  dayChips.innerHTML = "";
  days.forEach((d,i)=>{
    const idx = i+1;
    const btn = document.createElement("div");
    btn.className = "chip " + (currentDay===idx?"active":"");
    btn.innerText = d;
    btn.addEventListener("click", ()=>{ currentDay = idx; document.querySelectorAll(".chip").forEach(c=>c.classList.remove("active")); btn.classList.add("active"); renderTimetable(); startCountdownLoop(); });
    dayChips.appendChild(btn);
  });
  todayLabel.innerText = `Day: ${["Sun","Mon","Tue","Wed","Thu","Fri","Sat"][(new Date()).getDay()]}`;
}

// render structured table for currentDivision & currentDay
function renderTimetable(){
  const div = currentDivision;
  divisionSelect.value = div;
  const day = currentDay;
  const dayData = (timetable[div] && timetable[div][day]) ? timetable[div][day] : [];
  // create table rows for each item
  let html = `<table><thead><tr><th>#</th><th>Subject</th><th>Start</th><th>End</th></tr></thead><tbody>`;
  if(dayData.length === 0){
    html += `<tr><td colspan="4">No data for this day. Click "Edit Timetable" to add.</td></tr>`;
  } else {
    dayData.forEach((it, idx)=>{
      if(editingMode){
        html += `<tr class="editable">
          <td>${idx+1}</td>
          <td><input class="tt-input" data-div="${div}" data-day="${day}" data-idx="${idx}" data-col="subject" value="${escapeHtml(it.subject)}"/></td>
          <td><input class="tt-input" data-div="${div}" data-day="${day}" data-idx="${idx}" data-col="start" value="${escapeHtml(it.start)}"/></td>
          <td><input class="tt-input" data-div="${div}" data-day="${day}" data-idx="${idx}" data-col="end" value="${escapeHtml(it.end)}"/></td>
        </tr>`;
      } else {
        html += `<tr>
          <td>${idx+1}</td>
          <td>${escapeHtml(it.subject)}</td>
          <td>${escapeHtml(it.start)}</td>
          <td>${escapeHtml(it.end)}</td>
        </tr>`;
      }
    });
  }
  html += `</tbody></table>`;
  tableContainer.innerHTML = html;
  // update image
  loadImageForDivision(div);
}

// load image for current division
function loadImageForDivision(div){
  const src = divisionImages[div] || "";
  divImage.src = src;
  // if image not found, show fallback text (browser will show broken image)
}

// countdown logic: find current or next class and show countdown
function findCurrentOrNext(div, day){
  const now = new Date();
  const list = (timetable[div] && timetable[div][day]) ? timetable[div][day] : [];
  // convert each to startDate,endDate for same day
  const parsed = list.map((it, idx)=>{
    const s = timeToTodayDate(it.start);
    const e = timeToTodayDate(it.end);
    return {...it, idx, startDate:s, endDate:e};
  });

  // first check if any class is currently running
  for(const it of parsed){
    if(now >= it.startDate && now < it.endDate){
      return {type:"current", item:it};
    }
  }
  // else find next class whose start > now
  const upcoming = parsed.filter(it => it.startDate > now).sort((a,b)=>a.startDate - b.startDate);
  if(upcoming.length>0) return {type:"next", item:upcoming[0]};
  // none left
  return {type:"none", item:null};
}

function updateHeader(){
  const div = currentDivision;
  const day = currentDay;
  const result = findCurrentOrNext(div, day);
  if(result.type === "current"){
    const it = result.item;
    currentClassText.innerText = `Ongoing: ${it.subject} — ends at ${it.end}`;
    // countdown to end
    setCountdownTo(it.endDate, ()=>{ startCountdownLoop(); });
  } else if(result.type === "next"){
    const it = result.item;
    currentClassText.innerText = `Next: ${it.subject} — starts at ${it.start}`;
    setCountdownTo(it.startDate, ()=>{ startCountdownLoop(); });
  } else {
    currentClassText.innerText = "No more classes today";
    countdownText.innerText = "";
  }
}

// start interval
function startCountdownLoop(){
  // clear previous interval
  if(countdownInterval) clearInterval(countdownInterval);
  // immediate update
  updateHeader();
  // keep updating every second (header will manage switching when time reached)
  countdownInterval = setInterval(()=> updateHeader(), 1000);
}

function setCountdownTo(targetDate, onFinish){
  function update(){
    const now = new Date();
    let diff = targetDate - now;
    if(diff <= 0){
      countdownText.innerText = "00:00:00";
      if(onFinish) onFinish();
      return;
    }
    const hrs = Math.floor(diff / (1000*60*60));
    diff -= hrs * (1000*60*60);
    const mins = Math.floor(diff / (1000*60));
    diff -= mins * (1000*60);
    const secs = Math.floor(diff / 1000);
    countdownText.innerText = `${pad2(hrs)}:${pad2(mins)}:${pad2(secs)}`;
  }
  update();
  // We rely on startCountdownLoop calling updateHeader every second, so no separate interval here.
}

function pad2(n){ return n.toString().padStart(2,"0"); }

function escapeHtml(s){
  if(!s) return "";
  return s.replaceAll("&","&amp;").replaceAll("<","&lt;").replaceAll(">","&gt;");
}

/* On initial load: if student saved -> open timetable */
window.addEventListener("load", ()=>{
  const st = getStudent();
  if(st){
    openTimetable();
  }
});

// helper: reset timetable_data to default (used by Reset)
function resetToDefault(){
  timetable = JSON.parse(JSON.stringify(defaultTimetable));
  saveTimetable(timetable);
}

/* small UX improvements: show current weekday name */
(function showWeekdayName(){
  const now = new Date();
  const names = ["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];
  document.title = `Smart Timetable — ${names[now.getDay()]}`;
})();

/* End of script */
</script>
</body>
</html>
